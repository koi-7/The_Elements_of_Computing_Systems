# 8章 バーチャルマシン#2：プログラム制御

## SimpleFunction

- return
  - 図8-5（p.179）、図8-8（p.183）を見ながら各ポインタがどう動いて各値がどこに退避されるかをイメージしながら記述する
  - 最後の ```goto RET``` のミスに気付かず最後まで FRAME まわりを睨んでた

```
// 誤
@RET
0;JMP

// 正
@RET
A=M
0;JMP
```

## FibonacciElement

- 図8-5を見ながら記述
- ```CodeWriter.writeInit()``` でブートストラップコードを記述する
  - VM 変換器に渡されたものがディレクトリであれば ```SP=256``` に加えて ```call Sys.init``` を表現するアセンブリコードを記述する
  - ```CodeWriter.writeInit()``` は引数を取らないため、```call Sys.init``` を記述するかどうかのヒントを各自で用意する必要がある
    - .vm ファイルが複数あるときに Sys.vm がどの順番で読み込まれるかわからないので入力ファイルのリストを作るついでに Sys.vm がリストの先頭にくるようにした
    - 最初に読み込まれたファイルが Sys.vm かそうでないかで場合分けを行った

## StaticTest

- Class1.vm、Class2.vm の両方に ```push static 0```、```push static 1``` などが存在するためてテキスト p.157 に書かれている通り、変数名は ```<.vm ファイル名>.index``` としなければならない
- スタティック変数については通常は7章で実装済みのため、FibonacciElement のテストが動けばそこからコードを追加することなく動くはず

